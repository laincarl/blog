---
title: 前端缓存
date: 2020-01-09 11:43:00
categories: 
- web前端
tags:
---

缓存可以分为强缓存和协商缓存

- 强缓存：主要用于不变的数据，比如hash处理过的图片，js，css
- 协商缓存：主要用于数据不会频繁变动的接口

<!-- more -->

### 如何启用缓存

缓存是浏览器和服务器之间进行配合来生效的，缓存由浏览器请求时或服务器返回时指定缓存方式，现代浏览器使用的是header`Cache-Control`

### 默认缓存

如果没有设置缓存方式，浏览器将使用`启发式缓存`，也就是使用Header中的Date减去Last-Modified的10%作为缓存时间

### Cache-Control

可以并列几个，例如

```javascript
Cache-Control: max-age=604800
Cache-Control: public
```

| 字段 | 意义 |
| --- | ---
|no-cache  |不使用强缓存  |
|no-store  |任何缓存都不使用  |
|max-age  |强缓存最长生效时间  |
|s-maxage  |针对代理商的强缓存最长生效时间  |
|private  |代理商不进行缓存  |

### 典型的场景（强缓存）

强缓存是指第二次请求时如果满足条件则使用缓存，`不需要`进行网络请求，其中的条件就是判断文件是否更改，浏览器可以通过最大生效时间判断
以下是一个典型场景

1. 浏览器发送请求
2. 服务器返回数据，并附带Response Header，其中包含`Cache-Control: max-age=604800`
3. 再次遇到相同请求时使用缓存时间和max-age来判断文件是否过期，若不过期则使用缓存，否则进入协商缓存阶段

### 典型的场景（协商缓存）

协商缓存是指第二次请求时如果满足条件则使用缓存，`需要`进行网络请求，只是减少了文件的数据量传输，这其中有两种方式，一种通过资源的上次修改时间来判断，另一种通过资源生成的哈希码来判断，以下是两种方式的典型场景
以下是一个典型场景（使用LastModified）

1. 浏览器发送请求
2. 服务器返回数据，并附带Response Header，其中包含`Last-Modified: Tue, 07 Jan 2020 01:40:13 GMT`
3. 浏览器再次遇到相同请求时，带上 `If-Modified-Since: Tue, 07 Jan 2020 01:40:13 GMT`,服务器判断资源是否更改，若没有更改直接返回状态码`304`，否则返回资源和新的last-modified
4. 浏览器接收到返回值，如果是302状态码，使用缓存，否则使用返回的资源，并更新缓存

以下是一个典型场景（使用ETag）

1. 浏览器发送请求
2. 服务器返回数据，并附带Response Header，其中包含`ETag: W/"5e13e17d-54f"`
3. 浏览器再次遇到相同请求时，带上 `If-None-Match: W/"5e13e17d-54f"`,服务器判断资源是否更改，若没有更改直接返回状态码`304`，否则返回资源和新的ETag
4. 浏览器接收到返回值，如果是302状态码，使用缓存，否则使用返回的资源，并更新缓存

#### 两种协商缓存的优劣

- 通过last-modified服务器需要进行的计算量很小，但是由于最小单位是秒，所以当资源在短时间内(1s内)频繁更新时可能无法检测出来，或者资源更改了，但是值没变，也无法判断出来
- 通过ETag判断时，服务器需要使用资源生成哈希码，会耗费更大的计算力，但是很准确
